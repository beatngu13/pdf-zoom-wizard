name: Build

on: push

env:
  GRAALVM_VERSION: 21.1.0.java11

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v2.3.4
        with:
          # fetch unshallow to enable blame for Sonar
          fetch-depth: 0

      - name: Set up GraalVM
        uses: DeLaGuardo/setup-graalvm@master
        with:
          graalvm-version: ${{ env.GRAALVM_VERSION }}

      - name: Cache Maven
        uses: actions/cache@v2.1.6
        with:
          path: ~/.m2/repository/
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}-${{ secrets.CACHE_VERSION }}

      - name: Cache Sonar
        uses: actions/cache@v2.1.6
        with:
          path: ~/.sonar/cache/
          key: ${{ runner.os }}-sonar-${{ secrets.CACHE_VERSION }}

      - name: Install PDF Clown
        run: |
          ./install-pdf-clown.sh

      - name: Maven verify
        run: |
          mvn verify -B -Pcoverage

      - name: Run Sonar analysis
        # see https://github.com/dependabot/dependabot-core/issues/3253#issuecomment-852541544
        if: ${{ github.actor != 'dependabot[bot]' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: >
          mvn sonar:sonar -B
          -Dsonar.host.url=https://sonarcloud.io
          -Dsonar.organization=beatngu13-github
          -Dsonar.projectKey=com.github.beatngu13:pdfzoomwizard

      - name: Move JAR to staging directory
        run: |
          mkdir ./staging/
          cp ./target/pdfzoomwizard-*.jar ./staging/pdfzoomwizard.jar

      - name: Upload JAR
        uses: actions/upload-artifact@v2.2.4
        with:
          name: artifacts
          path: ./staging/pdfzoomwizard.jar

  native-linux:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v2.3.4

      - name: Set up GraalVM
        uses: DeLaGuardo/setup-graalvm@master
        with:
          graalvm-version: ${{ env.GRAALVM_VERSION }}

      - name: Cache Maven
        uses: actions/cache@v2.1.6
        with:
          path: ~/.m2/repository/
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}-${{ secrets.CACHE_VERSION }}

      - name: Install libraries
        run: >
          sudo apt install
          libasound2-dev
          libavcodec-dev
          libavformat-dev
          libavutil-dev
          libgl-dev
          libgtk-3-dev
          libpango1.0-dev
          libxtst-dev

      - name: Install PDF Clown
        run: |
          ./install-pdf-clown.sh

      - name: Maven compile and link
        run: |
          mvn gluonfx:build -B

      - name: Prepare native image for upload
        run: |
          cp "./target/gluonfx/x86_64-linux/PDF Zoom Wizard" ./pdfzoomwizard-linux
          tar --create --gzip --file ./pdfzoomwizard-linux.tar.gz ./pdfzoomwizard-linux

      - name: Upload native image
        uses: actions/upload-artifact@v2.2.4
        with:
          name: artifacts
          path: ./pdfzoomwizard-linux.tar.gz

  native-macos:
    needs: build
    runs-on: macos-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v2.3.4

      - name: Set up GraalVM
        uses: DeLaGuardo/setup-graalvm@master
        with:
          graalvm-version: ${{ env.GRAALVM_VERSION }}

      - name: Cache Maven
        uses: actions/cache@v2.1.6
        with:
          path: ~/.m2/repository/
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}-${{ secrets.CACHE_VERSION }}

      - name: Install PDF Clown
        run: |
          ./install-pdf-clown.sh

      - name: Maven compile and link
        run: |
          mvn gluonfx:build -B

      - name: Prepare native image for upload
        run: |
          cp "./target/gluonfx/x86_64-darwin/PDF Zoom Wizard" ./pdfzoomwizard-macos
          tar --create --gzip --file ./pdfzoomwizard-macos.tar.gz ./pdfzoomwizard-macos

      - name: Upload native image
        uses: actions/upload-artifact@v2.2.4
        with:
          name: artifacts
          path: ./pdfzoomwizard-macos.tar.gz

  native-windows:
    needs: build
    runs-on: windows-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v2.3.4

      - name: Set up GraalVM
        uses: DeLaGuardo/setup-graalvm@master
        with:
          graalvm-version: ${{ env.GRAALVM_VERSION }}

      - name: Cache Maven
        uses: actions/cache@v2.1.6
        with:
          path: ~/.m2/repository/
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}-${{ secrets.CACHE_VERSION }}

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v1.0.2

      - name: Set up Visual Studio shell
        uses: egor-tensin/vs-shell@v2

      - name: Install PDF Clown
        run: |
          bash ./install-pdf-clown.sh

      - name: Maven compile and link
        run: |
          mvn gluonfx:build -B

      - name: Prepare native image for upload
        run: |
          cp "./target/gluonfx/x86_64-windows/PDF Zoom Wizard.exe" ./pdfzoomwizard-windows.exe

      - name: Upload native image
        uses: actions/upload-artifact@v2.2.4
        with:
          name: artifacts
          path: ./pdfzoomwizard-windows.exe

  release:
    if: ${{ startsWith(github.ref, 'refs/tags/v') }}
    needs: [ native-linux, native-macos, native-windows ]
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v2.0.10
        with:
          name: artifacts

      - name: Create GitHub release
        uses: softprops/action-gh-release@v0.1.5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          draft: true
          files: |
            ./pdfzoomwizard-linux.tar.gz
            ./pdfzoomwizard-macos.tar.gz
            ./pdfzoomwizard-windows.exe
            ./pdfzoomwizard.jar
